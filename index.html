<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3c72">
    <title>HVSR Sismómetro Móvil</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Iconos -->
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* === estilos (igual que tu versión anterior) === */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            padding: 10px;
        }
        .container { max-width: 500px; margin: 0 auto; }
        .component-value { font-size: 18px; font-weight: bold; font-family: monospace; }
        /* ... resto de tus estilos ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>🌍 HVSR Sismómetro</h1>
        <p>Medición de Cociente Espectral H/V - Protocolo SESAME</p>
        
        <div>
            <div>X (N-S): <span id="x-value">0.0000</span> m/s²</div>
            <div>Y (E-W): <span id="y-value">0.0000</span> m/s²</div>
            <div>Z (Vertical): <span id="z-value">0.0000</span> m/s²</div>
            <div>Muestreo: <span id="sampling">-- Hz</span></div>
        </div>
    </div>

<script>
/* ================== MÁXIMA SENSIBILIDAD ================== */
const MAX_FREQ_REQUEST = 200;  // Hz objetivo
const DISPLAY_UPDATE_MS = 50;  // refresco pantalla
const DECIMALS = 4;            // más precisión
let currentAcceleration = {x:0,y:0,z:0};
let sampleCount=0, startPerf=0, lastDisplayUpdate=0;
let actualSampleRate=0;

/* Generic Sensor API */
async function setupHighResSensor(){
  startPerf = performance.now();
  sampleCount = 0;
  lastDisplayUpdate = 0;

  let gsSensor;
  if ('LinearAccelerationSensor' in window) {
    gsSensor = new LinearAccelerationSensor({ frequency: MAX_FREQ_REQUEST });
    console.log("LinearAccelerationSensor disponible");
  } else if ('Accelerometer' in window) {
    gsSensor = new Accelerometer({ frequency: MAX_FREQ_REQUEST });
    console.log("Accelerometer genérico disponible");
  } else {
    throw new Error("Generic Sensor API no disponible");
  }

  gsSensor.addEventListener('reading', () => {
    sampleCount++;
    currentAcceleration.x = gsSensor.x || 0;
    currentAcceleration.y = gsSensor.y || 0;
    currentAcceleration.z = gsSensor.z || 0;

    const now = performance.now();
    if (now - lastDisplayUpdate >= DISPLAY_UPDATE_MS) {
      document.getElementById('x-value').textContent = currentAcceleration.x.toFixed(DECIMALS);
      document.getElementById('y-value').textContent = currentAcceleration.y.toFixed(DECIMALS);
      document.getElementById('z-value').textContent = currentAcceleration.z.toFixed(DECIMALS);
      lastDisplayUpdate = now;
    }
  });
  gsSensor.start();

  // calcular frecuencia real tras 5 s
  setTimeout(()=>{
    const elapsed=(performance.now()-startPerf)/1000;
    actualSampleRate=Math.round(sampleCount/elapsed);
    document.getElementById('sampling').textContent=`${actualSampleRate} Hz`;
    console.log("Frecuencia real:",actualSampleRate,"Hz");
  },5000);
}

/* Fallback DeviceMotion */
function setupMotionListener(){
  startPerf=performance.now();
  sampleCount=0; lastDisplayUpdate=0;
  window.addEventListener('devicemotion', e=>{
    const acc=e.acceleration && e.acceleration.x!==null ? e.acceleration : e.accelerationIncludingGravity || {x:0,y:0,z:0};
    sampleCount++;
    currentAcceleration.x=acc.x||0;
    currentAcceleration.y=acc.y||0;
    currentAcceleration.z=acc.z||0;
    const now=performance.now();
    if (now-lastDisplayUpdate>=DISPLAY_UPDATE_MS){
      document.getElementById('x-value').textContent=currentAcceleration.x.toFixed(DECIMALS);
      document.getElementById('y-value').textContent=currentAcceleration.y.toFixed(DECIMALS);
      document.getElementById('z-value').textContent=currentAcceleration.z.toFixed(DECIMALS);
      lastDisplayUpdate=now;
    }
  }, {capture:true});
  setTimeout(()=>{
    const elapsed=(performance.now()-startPerf)/1000;
    actualSampleRate=Math.round(sampleCount/elapsed);
    document.getElementById('sampling').textContent=`${actualSampleRate} Hz`;
    console.log("Frecuencia real:",actualSampleRate,"Hz");
  },5000);
}

/* Inicialización */
document.addEventListener('DOMContentLoaded', ()=>{
  if ('LinearAccelerationSensor' in window || 'Accelerometer' in window){
    setupHighResSensor().catch(err=>{
      console.log("Fallo GenericSensor:",err);
      setupMotionListener();
    });
  } else {
    setupMotionListener();
  }
});
</script>
</body>
</html>
